stages:
  - scan
  - analyze
  - remediate
  - report

variables:
  PROJECT_NAME: "default"
  TERRAFORM_PATH: "./infrastructure"
  NODE_VERSION: "20"

# Drift Detection Scan
drift:scan:
  stage: scan
  image: node:${NODE_VERSION}
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts scan \
        --project "$PROJECT_NAME" \
        --terraform "$TERRAFORM_PATH" \
        --output drift-report.json \
        --format json
    
    - DRIFT_COUNT=$(jq '.summary.drifted' drift-report.json)
    - echo "DRIFT_COUNT=$DRIFT_COUNT" >> drift.env
    - |
      if [ "$DRIFT_COUNT" -gt 0 ]; then
        echo "DRIFT_DETECTED=true" >> drift.env
      else
        echo "DRIFT_DETECTED=false" >> drift.env
      fi
  artifacts:
    reports:
      dotenv: drift.env
    paths:
      - drift-report.json
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

# Security Analysis
security:analyze:
  stage: analyze
  image: node:${NODE_VERSION}
  needs: 
    - drift:scan
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts analyze \
        --project "$PROJECT_NAME" \
        --security \
        --output security-report.json
  artifacts:
    paths:
      - security-report.json
    expire_in: 30 days
  only:
    variables:
      - $DRIFT_DETECTED == "true"
  tags:
    - docker

# Cost Impact Analysis
cost:analyze:
  stage: analyze
  image: node:${NODE_VERSION}
  needs:
    - drift:scan
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts analyze \
        --project "$PROJECT_NAME" \
        --cost \
        --output cost-report.json
  artifacts:
    paths:
      - cost-report.json
    expire_in: 30 days
  only:
    variables:
      - $DRIFT_DETECTED == "true"
  tags:
    - docker

# Compliance Check
compliance:check:
  stage: analyze
  image: node:${NODE_VERSION}
  needs:
    - drift:scan
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts analyze \
        --project "$PROJECT_NAME" \
        --compliance CIS \
        --output compliance-report.json
  artifacts:
    paths:
      - compliance-report.json
    expire_in: 30 days
  only:
    - main
    - schedules
  tags:
    - docker

# ML Anomaly Detection
anomaly:detect:
  stage: analyze
  image: node:${NODE_VERSION}
  needs:
    - drift:scan
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts analyze \
        --project "$PROJECT_NAME" \
        --anomalies \
        --threshold 0.7 \
        --output anomaly-report.json
  artifacts:
    paths:
      - anomaly-report.json
    expire_in: 30 days
  only:
    variables:
      - $DRIFT_DETECTED == "true"
  tags:
    - docker

# Auto-Remediation (Dry Run)
remediate:plan:
  stage: remediate
  image: hashicorp/terraform:1.6
  needs:
    - drift:scan
    - security:analyze
  before_script:
    - apk add --no-cache nodejs npm
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts remediate \
        --project "$PROJECT_NAME" \
        --terraform "$TERRAFORM_PATH" \
        --dry-run \
        --output remediation-plan.json
  artifacts:
    paths:
      - remediation-plan.json
    expire_in: 30 days
  only:
    variables:
      - $DRIFT_DETECTED == "true"
  when: manual
  tags:
    - docker

# Auto-Remediation (Apply)
remediate:apply:
  stage: remediate
  image: hashicorp/terraform:1.6
  needs:
    - remediate:plan
  before_script:
    - apk add --no-cache nodejs npm
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts remediate \
        --project "$PROJECT_NAME" \
        --terraform "$TERRAFORM_PATH" \
        --auto-approve \
        --output remediation-result.json
  artifacts:
    paths:
      - remediation-result.json
    expire_in: 90 days
  only:
    - main
  when: manual
  environment:
    name: production
  tags:
    - docker

# Generate HTML Report
report:generate:
  stage: report
  image: node:${NODE_VERSION}
  needs:
    - drift:scan
    - security:analyze
    - cost:analyze
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      npx ts-node src/cli/index.ts report \
        --project "$PROJECT_NAME" \
        --format html \
        --output drift-report.html
  artifacts:
    paths:
      - drift-report.html
    expire_in: 30 days
  tags:
    - docker

# Merge Request Comment
mr:comment:
  stage: report
  image: node:${NODE_VERSION}
  needs:
    - drift:scan
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      REPORT=$(cat drift-report.json)
      DRIFT_COUNT=$(echo $REPORT | jq '.summary.drifted')
      CRITICAL=$(echo $REPORT | jq '.summary.critical')
      
      if [ "$DRIFT_COUNT" -gt 0 ]; then
        EMOJI="ðŸ”´"
        [ "$CRITICAL" -eq 0 ] && EMOJI="ðŸŸ¡"
        
        COMMENT="## $EMOJI Infrastructure Drift Detected\n\n"
        COMMENT="${COMMENT}**Drifted Resources:** $DRIFT_COUNT\n"
        COMMENT="${COMMENT}**Critical:** $CRITICAL\n\n"
        COMMENT="${COMMENT}[View full report]($CI_JOB_URL/artifacts/browse)"
        
        curl --request POST \
          --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          --data "body=$COMMENT" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
      fi
  only:
    - merge_requests
  tags:
    - docker

# Scheduled Scan
scheduled:scan:
  extends: drift:scan
  only:
    - schedules
  script:
    - |
      npx ts-node src/cli/index.ts scan \
        --project "$PROJECT_NAME" \
        --terraform "$TERRAFORM_PATH" \
        --output drift-report.json \
        --format json
    
    - CRITICAL_COUNT=$(jq '.summary.critical' drift-report.json)
    - |
      if [ "$CRITICAL_COUNT" -gt 0 ]; then
        echo "Critical drift detected: $CRITICAL_COUNT resources"
        exit 1
      fi
